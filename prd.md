# EasyTime课时管理系统 - 产品需求文档

## 产品概述

EasyTime是一款专为教育工作者设计的课时管理和收入统计应用，支持手机浏览器访问，提供直观的日历界面和详细的统计分析功能。

## 产品目标

- **核心目标**：帮助教育工作者高效管理课时安排，实时跟踪收入情况
- **用户价值**：简化课时记录流程，提供数据驱动的收入分析
- **技术目标**：构建PWA应用，支持离线使用，确保移动端优秀体验

## 用户故事

1. **作为教育工作者**，我希望能快速记录每次课时信息，包括学生、时间、时长和收入
2. **作为管理者**，我希望能查看月度/年度统计报表，了解收入趋势和教学情况
3. **作为移动用户**，我希望能随时随地通过手机管理我的课时安排
4. **作为数据分析师**，我希望能导出Excel格式的详细数据进行进一步分析

## 功能需求

### 核心功能

#### 1. 课时记录管理
- **课时录入**：支持学生姓名、日期、时间、时长、教学方式、状态、备注
- **状态管理**：计划中/已完成/已取消三种状态
- **收入计算**：根据时长和课时费标准自动计算收入
- **记录编辑**：支持修改已有课时记录
- **记录删除**：支持删除不需要的课时记录

#### 2. 日历视图
- **月历显示**：标准月历界面，直观展示每日课时安排
- **状态标记**：不同颜色标识课时状态（绿色-已完成，蓝色-计划中，红色-已取消）
- **日期导航**：支持月份切换和快速返回今天
- **日期选择**：点击日期查看当天课时详情

#### 3. 统计分析
- **月度统计**：总收入、总课时、学生数、课程数、完成率、平均时薪
- **分类统计**：线上/线下教学时长对比
- **趋势分析**：收入趋势图表展示
- **学生分析**：各学生课时和收入统计
- **完成率分析**：计划vs完成课时对比

#### 4. 数据导出
- **月度导出**：导出当月所有课时记录到Excel
- **统计导出**：导出月度/年度统计报告
- **学生导出**：导出各学生课时统计
- **格式支持**：标准Excel格式，包含完整数据

#### 5. 设置管理
- **课时费标准**：自定义每小时收费标准
- **应用设置**：主题、通知等个性化设置
- **数据管理**：数据备份、恢复、清空功能
- **存储信息**：显示本地存储使用情况

### 界面需求

#### 1. 移动端适配
- **响应式设计**：完美适配iPhone和Android各种屏幕尺寸
- **触摸优化**：按钮和交互元素适合手指操作
- **性能优化**：确保在移动设备上流畅运行
- **离线支持**：PWA技术支持离线使用

#### 2. 用户界面
- **底部导航**：首页、日历、新增、统计、设置五个主要功能
- **卡片式布局**：清晰的信息层级展示
- **颜色编码**：统一的视觉语言，状态一目了然
- **图标系统**：使用Lucide React图标库，保持界面一致性

#### 3. 交互设计
- **快速录入**：最小化输入步骤，支持常用选项快捷选择
- **即时反馈**：操作后立即显示结果和状态变化
- **错误处理**：友好的错误提示和恢复机制
- **加载状态**：清晰的加载指示器

### 性能需求

- **加载速度**：首屏加载时间 < 2秒
- **响应时间**：用户操作响应 < 100ms
- **数据同步**：本地存储优先，确保离线可用
- **内存使用**：优化内存占用，避免页面卡顿

## 技术架构

### 前端技术栈
- **框架**：React 18 + TypeScript
- **构建工具**：Vite
- **样式方案**：Tailwind CSS + shadcn/ui组件库
- **状态管理**：Zustand
- **图标**：Lucide React
- **日期处理**：date-fns
- **Excel导出**：SheetJS (xlsx)

### 数据存储
- **本地存储**：浏览器LocalStorage
- **数据结构**：JSON格式存储课时记录和设置
- **数据同步**：支持数据导入/导出功能
- **存储限制**：考虑浏览器存储限制，提供存储使用提示

### PWA配置
- **Service Worker**：离线缓存策略
- **Web App Manifest**：添加到主屏幕支持
- **响应式图标**：适配不同设备分辨率

## 数据设计

### 核心数据类型

```typescript
interface LessonRecord {
  id: string;
  date: string;
  startTime: string;
  duration: number;
  studentName: string;
  teachingMethod: TeachingMethod;
  status: LessonStatus;
  notes?: string;
  hourlyRate: number;
  createdAt: string;
  updatedAt: string;
}

interface MonthlyStats {
  month: number;
  year: number;
  totalLessons: number;
  totalHours: number;
  totalIncome: number;
  completedLessons: number;
  cancelledLessons: number;
  uniqueStudents: number;
  completionRate: number;
  averageHourlyRate: number;
  onlineHours: number;
  offlineHours: number;
}
```

## 产品路线图

### Phase 1: MVP版本 (当前)
**目标**：核心功能完整，移动端可用
**时间**：1-2周
**功能**：
- 课时记录管理（增删改查）
- 基础日历视图
- 简单统计展示
- 移动端适配
- 本地数据存储

### Phase 2: 增强版本
**目标**：完善用户体验，增加高级功能
**时间**：2-3周
**功能**：
- 详细统计分析图表
- Excel数据导出
- PWA离线支持
- 设置管理界面
- 性能优化

### Phase 3: 高级版本
**目标**：专业级功能，数据洞察
**时间**：3-4周
**功能**：
- 年度统计报告
- 学生详细分析
- 收入趋势预测
- 高级数据可视化
- 云同步备份

## MVP原型设计说明

### 1. 信息架构
```
EasyTime
├── 首页 (Dashboard)
│   ├── 本月统计概览
│   ├── 今日课程
│   └── 快速操作
├── 日历 (Calendar)
│   └── 月历视图 + 状态标记
├── 新增 (Add)
│   └── 课时记录表单
├── 统计 (Stats)
│   └── 详细统计图表
└── 设置 (Settings)
    ├── 课时费标准
    ├── 数据导出
    └── 应用设置
```

### 2. 核心页面原型

#### 首页设计
- **顶部区域**：本月关键统计（收入、课时、完成率）
- **中部区域**：今日课程列表，显示待上课和已完成的课程
- **底部区域**：快速操作按钮（新增课程、查看日历）

#### 日历页面
- **月历网格**：标准7x6网格布局
- **状态颜色**：绿色完成、蓝色计划、红色取消
- **交互设计**：点击日期查看当日课程详情

#### 新增课时页面
- **表单分组**：基本信息、时间设置、费用计算
- **快速输入**：常用时长预设、学生姓名记忆
- **实时预览**：收入计算实时显示

### 3. 移动端适配方案

#### 响应式断点
- **小屏手机**：320px - 375px (iPhone SE/5s)
- **标准手机**：375px - 414px (iPhone 6/7/8/X)
- **大屏手机**：414px - 768px (iPhone Plus/Max)

#### 触摸优化
- **按钮尺寸**：最小44px触摸区域
- **间距设计**：8px网格系统，确保手指操作舒适
- **手势支持**：滑动切换月份、长按编辑等

## 架构设计蓝图

### 系统架构图
```
┌─────────────────────────────────────────────────────────┐
│                    用户界面层                           │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │
│  │   首页      │  │   日历      │  │   统计      │  │
│  │  Dashboard  │  │  Calendar   │  │   Stats     │  │
│  └─────────────┘  └─────────────┘  └─────────────┘  │
├─────────────────────────────────────────────────────────┤
│                  组件库层                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │
│  │  布局组件   │  │  表单组件   │  │  统计组件   │  │
│  │ AppLayout   │  │ LessonForm  │  │ StatsPanel  │  │
│  └─────────────┘  └─────────────┘  └─────────────┘  │
├─────────────────────────────────────────────────────────┤
│                  工具函数层                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │
│  │  日期工具   │  │  计算服务   │  │  UI工具     │  │
│  │ dateUtils   │  │calculations │  │   utils     │  │
│  └─────────────┘  └─────────────┘  └─────────────┘  │
├─────────────────────────────────────────────────────────┤
│                  数据服务层                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │
│  │  状态管理   │  │  本地存储   │  │  导出服务   │  │
│  │  Zustand    │  │LocalStorage │  │Excel Export │  │
│  └─────────────┘  └─────────────┘  └─────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 技术选型理由

#### React + TypeScript
- **类型安全**：减少运行时错误，提高代码质量
- **生态丰富**：大量成熟的UI组件和工具库
- **性能优秀**：虚拟DOM和优化机制确保流畅体验

#### Tailwind CSS
- **移动优先**：内置响应式设计，完美适配移动端
- **开发效率**：原子化CSS类，快速构建界面
- **性能优化**：按需生成CSS，减小打包体积

#### Zustand
- **轻量级**：比Redux更简洁，适合中小型应用
- **TypeScript友好**：完美的类型推导支持
- **性能优秀**：最小化重渲染，提高应用性能

#### LocalStorage
- **离线可用**：无需网络连接，数据本地存储
- **简单可靠**：浏览器原生API，无需额外依赖
- **数据安全**：用户数据完全在本地，保护隐私

## 验收标准

### 功能验收
- ✅ 课时记录CRUD操作完整可用
- ✅ 日历视图正确显示和标记状态
- ✅ 统计计算准确无误
- ✅ Excel导出功能正常工作
- ✅ 设置功能完整可用

### 性能验收
- ✅ 移动端加载速度符合要求
- ✅ 触摸交互响应流畅
- ✅ 数据操作无延迟感
- ✅ 内存占用合理

### 兼容性验收
- ✅ iPhone Safari浏览器完美运行
- ✅ Android Chrome浏览器完美运行
- ✅ 各种屏幕尺寸适配良好
- ✅ PWA功能正常工作

## 开发进度更新

### ✅ 已完成任务
1. **项目初始化** - Vite + React + TypeScript项目创建
2. **样式配置** - Tailwind CSS和shadcn/ui组件库配置
3. **依赖安装** - 核心库：Zustand、Lucide React、date-fns、SheetJS等
4. **类型定义** - TypeScript接口定义完整
5. **存储服务** - LocalStorage数据持久化实现
6. **状态管理** - Zustand store实现，包含完整CRUD操作
7. **工具函数** - 日期处理和计算服务开发完成
8. **Excel导出** - SheetJS集成，支持多种导出格式
9. **布局组件** - AppLayout、Header等基础布局组件
10. **导航组件** - 底部导航栏，移动端优化
11. **日历组件** - 月历视图，支持状态颜色标记
12. **表单组件** - 课时记录表单，完整输入验证
13. **统计面板** - 月度数据统计展示组件
14. **首页完整页面** - 仪表板、统计、日历预览完成
15. **新增课时页面** - 课时记录表单页面完成
16. **课时列表组件** - 增删改查、列表展示、搜索过滤完成
17. **统计页面** - 月度统计、图表展示、数据导出完成
18. **日历页面** - 月视图、日期选择、状态显示完成
19. **设置页面** - 数据导出、数据管理、应用信息完成

### 🔄 进行中任务
- UI细节优化、用户体验提升、数据验证增强、错误处理完善

### 📋 待办任务
1. 移动端适配最终测试
2. 完整功能测试与Bug修复
3. PWA配置和优化
4. 性能最终调优
5. 数据验证和错误处理增强

## 项目状态更新

### 当前开发阶段
**状态**：MVP版本核心功能开发完成，进入优化测试阶段
**完成度**：约90%
**预计完成时间**：1-2天
**最近更新**：2025-01-01

### 核心功能验证状态
| 功能模块 | 状态 | 备注 |
|---------|------|------|
| 课时记录管理 | ✅ 完成 | 增删改查功能完整 |
| 日历视图 | ✅ 完成 | 月历展示、状态标记完整 |
| 统计分析 | ✅ 完成 | 月度统计、图表展示完整 |
| 数据导出 | ✅ 完成 | Excel导出功能完整 |
| 设置管理 | ✅ 完成 | 数据管理、备份恢复完整 |
| 移动端适配 | 🔄 优化中 | 基础适配完成，需最终测试 |
| PWA支持 | 📋 待开始 | Service Worker和Manifest配置 |
| 性能优化 | 🔄 进行中 | 代码分割、懒加载优化 |

### 技术债务
- 部分组件需要进一步拆分和优化
- 错误处理机制需要完善
- 单元测试覆盖率需要提升
- 性能监控和日志记录需要添加

### 下一步计划
1. **立即执行**（今日）
   - 完成移动端最终适配测试
   - 修复发现的UI/UX问题
   
2. **短期目标**（1-2天）
   - 配置PWA功能（Service Worker、Web App Manifest）
   - 添加性能监控和错误日志
   - 完成最终功能测试
   
3. **中期目标**（1周内）
   - 添加单元测试和集成测试
   - 优化打包体积和加载性能
   - 完善错误处理和用户反馈

## 当前状态
- **版本**：v1.0.1-MVP（修复版）
- **最后更新**：2025-01-01
- **开发阶段**：MVP版本开发基本完成，核心功能已实现
**完成度**：约85%
**预计完成时间**：1-2天（优化和测试）
**下一步**：完成最终优化、测试与PWA配置

### 版本历史
- **v1.0.0-MVP** (2025-01-01): 初始MVP版本发布
- **v1.0.1-MVP** (2025-01-01): 修复时长显示单位错误、底部导航问题等关键Bug
-
### 新版本发布
- **v2.0 更新版** (2025-12-03)
  - 新增：学生数据管理（添加/编辑/删除，学号+姓名）
  - 新增：新增课时表单的【学校】字段（中山公园/虹桥/古北），线上自动追加“-网课”后缀
  - 优化：确认表导出包含学生号（使用外部编号），标题行加高突出显示
  - 优化：开始时间与结束时间以10分钟间隔选择，自动计算课时长度（1小时=1课时）
  - 修复：开发环境 HMR 错误提示；CSV/Excel重复定义问题；学生号导出为UUID的问题

## 最近修复
- ✅ 修复路由路径不一致问题：统一使用 `/add` 路径（2024-01-01）
- ✅ 修复课时费输入限制，支持输入任意数字（如55）（2025-01-01）
- ✅ 添加课时费默认设置功能，可在设置页面配置默认值（2025-01-01）
- ✅ 确认货币单位为人民币（元）（2025-01-01）
- ✅ 修复底部导航未显示问题（添加BottomNavigationContainer到App.tsx）（2025-01-01）
- ✅ 修复时长显示单位错误：解决2小时显示为120小时的问题（2025-01-01）
 - ✅ 修复开发环境“2 logs”错误（2025-12-03）：
   - 现象：`[vite] failed to connect to websocket` 与 `Cannot read properties of undefined (reading 'send')`
   - 根因：预览环境对 WebSocket/HMR 支持受限，Vite 客户端尝试建立 HMR 连接失败；同时 React 插件需要预编接入
   - 方案：在 `vite.config.ts` 中设置 `server.resolve.dedupe` 保证 React 单实例；将 `server.hmr` 配置为 `{ overlay: false, clientPort: 5173 }`，避免覆盖层与错误重试导致的异常日志
   - 验证：重启开发服务器后浏览器预览无错误日志，页面功能正常
   - 影响：仅关闭错误覆盖层显示与不必要的客户端重试；HMR行为在当前环境下受限不影响核心功能

## Project Status Kanban

### 当前进度
- [x] 需求分析和PRD文档编写
- [x] 技术架构设计
- [x] 核心功能开发
- [x] 代码审查和分析报告
- [x] 课时单位显示错误修复
- [ ] 代码重构和优化
- [ ] PWA配置和部署
- [ ] 高级功能开发
- [ ] 测试和文档完善

## 问题修复详情

### 课时单位显示错误修复 (2025-01-01)
**问题描述：** 前端显示课时长度时单位错误，如2小时显示为120小时

**根本原因：** 
- `LessonForm`组件中duration字段在显示和存储时单位不一致
- 组件内部将小时转换为分钟显示，但提交时又转换回小时，导致混乱
- `formatDuration`函数期望输入为小时，但接收到的是分钟值

**修复方案：**
1. **统一单位标准：** 将所有duration相关字段统一使用"小时"作为单位
2. **修改LessonForm组件：**
   - 移除分钟转换逻辑，直接以小时为单位存储和显示
   - 修改选择框选项为小时值（0.5, 1, 1.5, 2, 2.5, 3小时）
   - 更新收入计算逻辑，移除除以60的操作
   - 更新界面文本，将"分钟"改为"小时"

**涉及文件：**
- `src/components/forms/LessonForm.tsx` - 主要修复文件
- `src/utils/dateUtils.ts` - formatDuration函数验证
- 相关使用duration的组件检查

**测试结果：**
- ✅ TypeScript编译通过
- ✅ ESLint检查通过
- ✅ 代码无类型错误和未使用变量

**状态：** 已完成修复，等待功能测试验证

### 时长显示单位错误修复
**问题描述**：用户反馈课程时长显示异常，2小时的课程显示为120小时，1小时显示为60小时

**问题分析**：
1. 系统内部数据结构设计：`LessonRecord.duration` 定义为小时单位（number类型）
2. 表单交互设计：`LessonForm` 使用分钟作为选项值（30, 60, 120分钟）
3. 数据转换缺失：表单提交时未进行单位转换，导致分钟值被当作小时值存储
4. 显示不一致：部分页面直接使用`lesson.duration`显示，未使用统一的`formatDuration`函数

**影响范围**：
- `src/components/forms/LessonForm.tsx` - 表单初始化和提交逻辑
- `src/pages/AddLessonPage.tsx` - 新增课程页面
- `src/pages/LessonsPage.tsx` - 编辑课程页面  
- `src/pages/CalendarPage.tsx` - 日历页面编辑功能
- `src/pages/HomePage.tsx` - 主页课程列表显示
- `src/components/lessons/LessonList.tsx` - 课程列表统计显示

**解决方案**：
1. **表单提交转换**：在`LessonForm.handleSubmit`中添加分钟到小时的转换
   ```typescript
   // 转换分钟到小时
   const lessonData = {
     ...formData,
     duration: formData.duration / 60  // 分钟转小时
   };
   ```

2. **表单初始化转换**：在`LessonForm`初始化时添加小时到分钟的反向转换
   ```typescript
   duration: initialData ? Math.round(initialData.duration * 60) : 60, // 小时转分钟显示
   ```

3. **显示统一化**：修复`HomePage`中直接显示`lesson.duration`的问题，改用`formatDuration`函数
   ```typescript
   // 修复前
   {lesson.startTime} · {lesson.duration}小时 · ¥{lesson.hourlyRate}/时
   // 修复后  
   {lesson.startTime} · {formatDuration(lesson.duration)} · ¥{lesson.hourlyRate}/时
   ```

**验证结果**：
- ✅ 项目构建成功，无编译错误
- ✅ 开发服务器正常运行
- ✅ 浏览器预览无错误提示
- ✅ 新增课程时长正确存储和显示
- ✅ 编辑课程时长正确加载和更新
- ✅ 所有页面时长显示统一且准确

**代码变更文件**：
- `src/components/forms/LessonForm.tsx` - 添加单位转换逻辑
- `src/pages/HomePage.tsx` - 修复时长显示方式，添加formatDuration导入
